<!DOCTYPE html>
<html lang="en">
  <head>
    <title>LoanX - P2P Lending Platform</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      rel="stylesheet"
      id="bootstrap-css"
    />
    <link
      href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css"
      rel="stylesheet"
      integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN"
      crossorigin="anonymous"
    />
    <link href="css/requests_page.css" rel="stylesheet" />
    <link href="css/style1.css" rel="stylesheet" />
    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="fonts/icomoon/style.css" />

    <link
      href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,700"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="fonts/icomoon/style.css" />
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/jquery-ui.css" />
    <link rel="stylesheet" href="css/jquery.fancybox.min.css" />
    <link rel="stylesheet" href="css/bootstrap-datepicker.css" />
    <link rel="stylesheet" href="fonts/flaticon/font/flaticon.css" />
    <link rel="stylesheet" href="css/aos.css" />
    <link rel="stylesheet" href="css/style.css" />
    <!------ Include the above in your HEAD tag ---------->
  </head>
  <body style="background-image: url(images/untitled.jpg);">
    <header
      class="site-navbar py-4 js-sticky-header site-navbar-target"
      role="banner"
    >
      <div class="container">
        <div class="row align-items-center">
          <div class="col-6 col-xl-2">
            <h1 class="mb-0 site-logo">
              <a href="index.html" class="h2 mb-0"
                >LoanX<span class="text-danger" style="font-size: 1rem;"
                  >Lender</span
                >
              </a>
            </h1>
          </div>

          <div class="col-12 col-md-10 d-none d-xl-block">
            <nav
              class="site-navigation position-relative text-right"
              role="navigation"
            >
              <ul
                class="site-menu main-menu js-clone-nav mr-auto d-none d-lg-block"
              >
                <li>
                  <a href="lender_homepage.html" class="nav-link">Home</a>
                </li>
                <li>
                  <a href="#register-section" class="nav-link active"
                    >Borrow Requests</a
                  >
                </li>
                <li>
                  <a href="#register-section" class="nav-link">Activity</a>
                </li>
                <li>
                  <a href="#team-section" class="nav-link">Team</a>
                </li>
                <li>
                  <a href="#team-section" class="nav-link">Profile</a>
                </li>
              </ul>
            </nav>
          </div>

          <div
            class="col-6 d-inline-block d-xl-none ml-md-0 py-3"
            style="position: relative; top: 3px;"
          >
            <a href="#" class="site-menu-toggle js-menu-toggle float-right"
              ><span class="icon-menu h3"></span
            ></a>
          </div>
        </div>
      </div>
    </header>

    <br />
    <br />
    <br />
    <br />

    <section>
      <div class="container mb-4" style="background-color: white;">
        <div class="row">
          <div class="col-12">
            <div class="table-responsive">
              <table class="table table-striped">
                <thead style="background-color: red;">
                  <tr>
                    <th scope="col"></th>
                    <th scope="col">Borrower Name</th>
                    <th scope="col">Amount Requested</th>
                    <th scope="col" class="text-center">Status</th>
                    <th scope="col" class="text-right">Rate</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody id="requestData">
                  <!-- Data is dynamically loaded-->
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </section>

    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />

    <!-- Footer -->
    <footer class="text-light">
      <div class="container">
        <div class="row">
          <div class="col-md-3 col-lg-4 col-xl-3">
            <h5>About</h5>
          </div>

          <div class="col-md-2 col-lg-2 col-xl-2 mx-auto">
            <h5>Informations</h5>
          </div>

          <div class="col-md-3 col-lg-2 col-xl-2 mx-auto">
            <h5>Others links</h5>
          </div>

          <div class="col-md-4 col-lg-3 col-xl-3">
            <h5>Contact</h5>
          </div>
        </div>
      </div>
    </footer>

    <script src="js/jquery-3.3.1.min.js"></script>
    <script src="js/jquery-ui.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <script src="js/owl.carousel.min.js"></script>
    <script src="js/jquery.countdown.min.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/aos.js"></script>
    <script src="js/jquery.fancybox.min.js"></script>
    <script src="js/jquery.sticky.js"></script>
    <script src="js/isotope.pkgd.min.js"></script>
    <script src="js/main.js"></script>

    <script type="text/JavaScript" src="js/truffle-contract.js"></script>
    <script type="module" src="app.js"></script>

    <script type="text/JavaScript">
      function acceptRequest(btn) {
          const receiverAddress = btn.id;
          const amount = btn.value;
          const senderAddress = web3.eth.accounts;
          const web3Provider = init();
          const _amount = amount/16000;

          console.log(receiverAddress);
          console.log(senderAddress[0]);
          console.log(amount);

          var exec = web3.eth.sendTransaction({to:receiverAddress, from:senderAddress[0], value:web3.toWei(_amount, "ether")}, function (err, res) {
            if(err) {
              console.log(err);
            }
            else {
              var date = new Date(Date.now());
              date = date.toString();
              setStatusLender(receiverAddress, amount, date, web3Provider);
              setStatusBorrower(date, receiverAddress, web3Provider);
            }
          });
      }

      function setStatusLender (receiver, amount, date, web3Provider) {
        const account = web3.eth.accounts;
        $.getJSON("Lender.json", function (lender) {
          const lenderContract = TruffleContract(lender);
          lenderContract.setProvider(web3Provider);

          lenderContract
          .deployed()
          .then(function (instance) {
            return instance.Grant_Loan(receiver, amount, date, {
            from: account[0],
          });
          })
          .then(function (result) {
            console.log("Success!");
          })
          .catch(function (err) {
            console.log("Failed!");
            console.log(err);
          });
        });
      }

      function setStatusBorrower(date, receiver, web3Provider) {
        $.getJSON("Borrower.json", function (borrower) {
        const borrowerContract = TruffleContract(borrower);
        borrowerContract.setProvider(web3Provider);

        borrowerContract
        .deployed()
        .then(function (instance) {
            return instance.Loan_Granted(date, receiver);
        })
        .then(function (result) {
          console.log("Success");
        })
        .catch(function (err) {
          console.log("Failed");
          console.log(err);
        });
        });
      }

      function etherToInr () {
        var xmlhttp = new XMLHttpRequest();
        var url = "https://api.coinmarketcap.com/v1/ticker/ethereum/";

        xmlhttp.onreadystatechange = function () {
          if (this.readyState == 4 && this.status == 200) {
          var json = JSON.parse(this.responseText);
          parseJson(json[0]);
          }
        };

        xmlhttp.open("GET", url, true);
        xmlhttp.send();

        function parseJson(json) {
          var time = "<b>Last Updated : " + json["time"]["updated"] + "</b>";
          var inrValue = "$" + json["eth"]["price_inr"];

          console.log(inrValue);
          return inrValue;
          }
        }

      function init() {
        var web3Provider = null;

        if (window.ethereum) {
          web3Provider = window.ethereum;

          //Request account access
          try {
            window.ethereum.enable();
          } catch (error) {
            console.log(error);
          }
        }
       //Legacy Dapp browsers
        else if (window.web3) {
          web3Provider = window.web3.currentProvider;
        }
        //If no web3 instance is injected, use ganache
        else {
          web3Provider = new Web3.providers.HttpProvider("http://localhost:7545");
        }

        web3 = new Web3(web3Provider);

        return web3Provider;
      };
    </script>
  </body>
</html>
